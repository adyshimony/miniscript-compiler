<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miniscript Compiler</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🔨</text></svg>">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --container-bg: white;
            --text-color: #333;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-color: #e2e8f0;
            --border-focus: #667eea;
            --button-secondary-bg: #e2e8f0;
            --button-secondary-hover: #cbd5e0;
            --info-bg: #f7fafc;
            --success-bg: #c6f6d5;
            --success-border: #68d391;
            --error-bg: #fed7d7;
            --error-border: #fc8181;
            --error-text: #c53030;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-gradient: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
                --container-bg: #2d3748;
                --text-color: #e2e8f0;
                --text-secondary: #cbd5e0;
                --text-muted: #a0aec0;
                --border-color: #4a5568;
                --border-focus: #63b3ed;
                --button-secondary-bg: #4a5568;
                --button-secondary-hover: #718096;
                --info-bg: #2d3748;
                --success-bg: #22543d;
                --success-border: #38a169;
                --error-bg: #742a2a;
                --error-border: #e53e3e;
                --error-text: #feb2b2;
            }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-color);
            box-sizing: border-box;
        }

        .main-content {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .container {
            background: var(--container-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            color: var(--text-secondary);
            margin-top: 50px;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .input-section {
            margin-bottom: 30px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        #policy-input, #expression-input {
            width: 100%;
            height: 70px;
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
            background: var(--container-bg);
            color: var(--text-color);
            box-sizing: border-box;
        }
        
        #policy-input:focus, #expression-input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Policy editor specific styles */
        .policy-editor {
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
            min-height: 70px;
        }
        
        .policy-editor:empty::before {
            content: attr(data-placeholder);
            color: var(--text-muted);
            pointer-events: none;
        }
        
        /* Syntax highlighting colors */
        .syntax-function {
            color: #3b82f6;
            font-weight: 600;
        }
        
        .syntax-operator {
            color: #8b5cf6;
            font-weight: 600;
        }
        
        .syntax-key {
            color: #10b981;
            font-weight: 500;
        }
        
        .syntax-number {
            color: #f59e0b;
            font-weight: 500;
        }
        
        .syntax-parenthesis {
            color: var(--text-color);
            font-weight: bold;
        }
        
        .syntax-comma {
            color: var(--text-secondary);
        }
        
        /* Miniscript editor specific styles */
        .miniscript-editor {
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
            min-height: 70px;
        }
        
        .miniscript-editor:empty::before {
            content: attr(data-placeholder);
            color: var(--text-muted);
            pointer-events: none;
        }
        
        /* Miniscript-specific syntax highlighting colors */
        .syntax-fragment {
            color: #3b82f6;
            font-weight: 600;
        }
        
        .syntax-wrapper {
            color: #f59e0b;
            font-weight: 600;
        }
        
        .syntax-threshold {
            color: #8b5cf6;
            font-weight: 600;
        }
        
        .syntax-multisig {
            color: #ef4444;
            font-weight: 600;
        }
        
        .syntax-hash-fragment {
            color: #06b6d4;
            font-weight: 500;
        }
        
        /* HD wallet descriptor syntax highlighting */
        .syntax-descriptor-bracket {
            color: #64748b;
            font-weight: 600;
        }
        
        .syntax-fingerprint {
            color: #dc2626;
            font-weight: 500;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }
        
        .syntax-derivation-path {
            color: #059669;
            font-weight: 500;
        }
        
        .syntax-xpub {
            color: #7c3aed;
            font-weight: 500;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }
        
        .syntax-range {
            color: #ea580c;
            font-weight: 600;
        }
        
        .syntax-wildcard {
            color: #0891b2;
            font-weight: 600;
        }
        
        .syntax-pubkey {
            color: #be123c;
            font-weight: 500;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.95em;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            min-width: 0;
        }

        .button-group button {
            flex-shrink: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .examples-section .button-group {
            align-items: flex-start;
        }

        .examples-section .button-group button {
            font-size: 11px !important;
            padding: 4px 8px !important;
            min-width: 60px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .primary-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .secondary-btn {
            background: var(--button-secondary-bg);
            color: var(--text-secondary);
        }
        
        .secondary-btn:hover {
            background: var(--button-secondary-hover);
        }
        
        .danger-btn {
            background: #e53e3e;
            color: white;
        }
        
        .danger-btn:hover {
            background: #c53030;
        }
        
        .saved-expressions {
            margin-bottom: 20px;
        }
        
        .expression-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--info-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            min-width: 0;
        }

        .expression-info {
            flex: 1;
            min-width: 0;
            margin-right: 10px;
        }
        
        .expression-name {
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .expression-preview {
            font-family: monospace;
            color: var(--text-muted);
            font-size: 10px;
            word-break: break-all;
            line-height: 1.2;
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .result-box {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-family: monospace;
        }
        
        .error {
            background: var(--error-bg);
            border: 1px solid var(--error-border);
            color: var(--error-text);
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .success {
            background: var(--success-bg);
            border: 1px solid var(--success-border);
            color: var(--text-color);
        }
        
        .info {
            background: var(--info-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--container-bg);
            padding: 30px;
            border-radius: 12px;
            min-width: 300px;
            color: var(--text-color);
        }
        
        #save-name {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--container-bg);
            color: var(--text-color);
            box-sizing: border-box;
        }

        .key-variable-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            min-width: 0;
        }

        .key-info {
            flex: 1;
            min-width: 0;
            margin-right: 10px;
        }

        .key-name {
            font-weight: 600;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .key-value {
            font-family: monospace;
            color: var(--text-muted);
            font-size: 10px;
            word-break: break-all;
            line-height: 1.2;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .key-value.xonly {
            color: #8b5cf6;
        }

        .key-value.compressed {
            color: #3b82f6;
        }

        .key-badge {
            font-size: 8px;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .key-badge.xonly {
            background: #8b5cf6;
            color: white;
        }

        .key-badge.compressed {
            background: #3b82f6;
            color: white;
        }

        .key-badge.xpub {
            background: #10b981;
            color: white;
        }

        .key-badge.tpub {
            background: #f59e0b;
            color: white;
        }

        .add-key-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .add-key-form input {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--container-bg);
            color: var(--text-color);
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .add-key-form input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 10px;
                max-width: 100%;
            }

            .container {
                padding: 15px;
                margin-bottom: 15px;
            }

            h1 {
                font-size: 1.8em;
                margin-top: 20px;
                margin-bottom: 20px;
            }
            
            .button-group {
                gap: 8px;
                flex-direction: column;
            }

            .button-group button {
                font-size: 14px !important;
                padding: 12px !important;
                min-width: auto;
                width: 100%;
            }

            .examples-section .button-group {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .examples-section .button-group button {
                font-size: 10px !important;
                padding: 6px 8px !important;
                min-width: 60px;
                flex: 1;
            }

            #policy-input, #expression-input {
                font-size: 16px;
                padding: 12px 15px;
                height: 75px;
            }

            .add-key-form input {
                font-size: 16px;
                padding: 12px;
                height: auto;
            }

            .key-variable-item, .expression-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 12px;
            }

            .key-info, .expression-info {
                margin-right: 0;
                margin-bottom: 8px;
            }

            .radio-group {
                flex-direction: column;
                gap: 12px !important;
            }

            .radio-group label {
                font-size: 16px;
            }

            details summary {
                font-size: 16px;
                padding: 8px 0;
            }

            .result-box {
                padding: 15px;
                margin-bottom: 10px;
            }

            .result-box h4 {
                font-size: 16px;
            }

            textarea[readonly] {
                font-size: 12px !important;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 8px;
            }

            .container {
                padding: 12px;
            }

            h1 {
                font-size: 1.5em;
            }

            .examples-section .button-group button {
                font-size: 9px !important;
                padding: 4px 6px !important;
                min-width: 45px;
            }

            details > div {
                padding: 15px !important;
            }

            .modal-content {
                margin: 20px;
                min-width: auto;
                width: calc(100% - 40px);
            }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="container">
            <h1>🔨 Miniscript compiler</h1>
        
        <div class="input-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label for="policy-input">Policy (optional):</label>
                <div style="display: flex; align-items: center; gap: 0px;">
                    <button id="policy-key-names-toggle" onclick="togglePolicyKeyNames()" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Show key names" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        🏷️
                    </button>
                    <button onclick="removePolicyExtraChars()" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Remove extra characters" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        🧹
                    </button>
                    <button onclick="copyPolicyExpression()" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Copy policy expression" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        📋
                    </button>
                </div>
            </div>
            <div 
                id="policy-input" 
                contenteditable="true"
                data-placeholder="Enter your policy here (will be compiled to miniscript)..."
                class="policy-editor"
            ></div>
            
            <div class="examples-section" style="margin-top: 15px; display: flex; gap: 20px; align-items: flex-start; overflow: hidden;">
                <div class="examples-buttons" style="flex: 1; min-width: 0;">
                    <h4 style="margin-bottom: 10px; color: var(--text-secondary);" id="policy-examples-title">Basic examples:</h4>
                    <div class="button-group" style="align-items: flex-start;" id="policy-buttons-start">
                        <button onclick="showPolicyDescription('single'); loadPolicyExample('pk(Alice)')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Single key</button>
                        <button onclick="showPolicyDescription('or'); loadPolicyExample('or(pk(Alice),pk(Bob))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">OR keys</button>
                        <button onclick="showPolicyDescription('and'); loadPolicyExample('and(pk(Alice),pk(Bob))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">AND keys</button>
                        <button onclick="showPolicyDescription('threshold'); loadPolicyExample('thresh(2,pk(Alice),pk(Bob),pk(Charlie))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">2-of-3 Threshold</button>
                        <button onclick="showPolicyDescription('timelock'); loadPolicyExample('or(pk(Alice),and(pk(Bob),older(144)))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Alice OR (Bob + 1 day)</button>
                        <button onclick="showPolicyDescription('xonly'); loadPolicyExample('pk(David)')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">David (X-only)</button>
                        <button onclick="showPolicyDescription('testnet_xpub'); loadPolicyExample('pk(TestnetKey)')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Testnet xpub</button>
                    </div>
                    <h4 style="margin: 20px 0 10px 0; color: var(--text-secondary);">Complex examples:</h4>
                    <div class="button-group" style="align-items: flex-start;">
                        <button onclick="showPolicyDescription('corporate'); loadPolicyExample('or(thresh(2,pk(Alice),pk(Bob),pk(Charlie)),and(pk(Eva),after(1735689600)))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Corporate Wallet</button>
                        <button onclick="showPolicyDescription('recovery'); loadPolicyExample('or(95@pk(Alice),and(thresh(2,pk(Bob),pk(Charlie),pk(Eva)),older(1008)))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Emergency Recovery</button>
                        <button onclick="showPolicyDescription('twofa'); loadPolicyExample('and(pk(Alice),or(and(pk(Bob),hash160(6c60f404f8167a38fc70eaf8aa17ac351023bef8)),older(52560)))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">2FA + Backup</button>
                        <button onclick="showPolicyDescription('inheritance'); loadPolicyExample('or(pk(David),and(thresh(2,pk(Helen),pk(Ivan),pk(Julia)),older(26280)))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Taproot: Inheritance</button>
                        <button onclick="showPolicyDescription('delayed'); loadPolicyExample('or(and(pk(Julia),pk(Karl)),and(pk(David),older(144)))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Taproot: 2-of-2 OR Delayed</button>
                    </div>
                </div>
                
                <div class="policy-description-panel" style="flex: 0 0 300px; width: 300px; background: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; display: none; margin-top: 34px; overflow-wrap: break-word; word-wrap: break-word;" id="policy-description">
                    <div class="description-content">
                        <h5 style="margin: 0 0 8px 0; color: var(--accent-color); font-size: 14px;">📄 Click an example to see description</h5>
                        <p style="margin: 0; color: var(--secondary-text); font-size: 13px; line-height: 1.4;">Click any policy example button to learn about its spending conditions and use cases.</p>
                    </div>
                </div>
            </div>
            
            <!-- Mobile responsive CSS -->
            <style>
                @media (max-width: 768px) {
                    .examples-section {
                        flex-direction: column !important;
                        gap: 15px !important;
                    }
                    
                    .policy-description-panel {
                        margin-top: 0 !important;
                        flex: none !important;
                        max-width: none !important;
                        width: 100% !important;
                        margin-left: 0 !important;
                        margin-right: 0 !important;
                        box-sizing: border-box !important;
                    }
                    
                    #policy-description {
                        width: 100% !important;
                        max-width: 100% !important;
                    }
                }
                
                @media (max-width: 1024px) and (min-width: 769px) {
                    .policy-description-panel {
                        flex: 0 0 250px !important;
                        width: 250px !important;
                    }
                }
                
                @media (max-width: 1200px) and (min-width: 1025px) {
                    .policy-description-panel {
                        flex: 0 0 280px !important;
                        width: 280px !important;
                    }
                }
            </style>
            
            <div class="button-group" style="margin-top: 15px;">
                <button id="compile-policy-btn" class="primary-btn">🔨 Compile</button>
                <button id="save-policy-btn" class="secondary-btn">💾 Save</button>
                <button id="clear-policy-btn" class="secondary-btn">🗑️ Clear</button>
            </div>
        </div>
        
        <div id="policy-errors" style="margin-bottom: 20px;"></div>
        
        <div class="input-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label for="expression-input">Miniscript:</label>
                <div style="display: flex; align-items: center; gap: 0px;">
                    <button id="key-names-toggle" onclick="toggleKeyNames()" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Show key names" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        🏷️
                    </button>
                    <button onclick="removeMiniscriptExtraChars()" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Remove extra characters" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        🧹
                    </button>
                    <button onclick="copyMiniscriptExpression()" style="background: none; border: none; padding: 4px; margin: 0; cursor: pointer; font-size: 16px; color: var(--text-secondary); display: flex; align-items: center; border-radius: 3px;" title="Copy miniscript expression" onmouseover="this.style.backgroundColor='var(--button-secondary-bg)'" onmouseout="this.style.backgroundColor='transparent'">
                        📋
                    </button>
                </div>
            </div>
            <div 
                id="expression-input" 
                contenteditable="true"
                data-placeholder="Enter your miniscript here..."
                class="miniscript-editor"
            ></div>
            
            <div class="examples-section" style="margin-top: 15px; display: flex; gap: 20px; align-items: flex-start; overflow: hidden;">
                <div class="examples-buttons" style="flex: 1; min-width: 0;">
                    <h4 style="margin-bottom: 10px; color: var(--text-secondary);" id="miniscript-examples-title">Basic examples:</h4>
                    <div class="button-group" style="align-items: flex-start;" id="miniscript-buttons-start">
                        <button onclick="showMiniscriptDescription('single'); loadExample('pk(Alice)')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Single key</button>
                        <button onclick="showMiniscriptDescription('and'); loadExample('and_v(v:pk(Alice),pk(Bob))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">2-of-2 AND</button>
                        <button onclick="showMiniscriptDescription('or'); loadExample('or_b(pk(Alice),s:pk(Bob))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">OR keys</button>
                        <button onclick="showMiniscriptDescription('complex'); loadExample('and_v(v:pk(Alice),or_b(pk(Bob),s:pk(Charlie)))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Complex: Alice AND (Bob OR Charlie)</button>
                        <button onclick="showMiniscriptDescription('timelock'); loadExample('and_v(v:pk(Alice),and_v(v:older(144),pk(Bob)))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Timelock: Alice AND (1 day + Bob)</button>
                        <button onclick="showMiniscriptDescription('xonly'); loadExample('pk(David)')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">David (X-only)</button>
                    </div>
                    <h4 style="margin: 20px 0 10px 0; color: var(--text-secondary);">Complex examples:</h4>
                    <div class="button-group" style="align-items: flex-start;">
                        <button onclick="showMiniscriptDescription('multisig'); loadExample('or_d(pk(Alice),or_d(pk(Bob),pk(Charlie)))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">1-of-3 Multisig</button>
                        <button onclick="showMiniscriptDescription('recovery'); loadExample('or_d(pk(Alice),and_v(v:pk(Bob),older(1008)))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Recovery Wallet</button>
                        <button onclick="showMiniscriptDescription('hash'); loadExample('and_v(v:pk(Alice),or_d(pk(Bob),and_v(v:hash160(6c60f404f8167a38fc70eaf8aa17ac351023bef8),older(144))))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Hash + Timelock</button>
                        <button onclick="showMiniscriptDescription('inheritance'); loadExample('and_v(v:pk(David),or_d(pk(Helen),and_v(v:pk(Ivan),older(52560))))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Taproot: Inheritance</button>
                        <button onclick="showMiniscriptDescription('delayed'); loadExample('or_d(pk(Julia),and_v(v:pk(Karl),older(144)))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Taproot: Immediate OR Delayed</button>
                        <button onclick="showMiniscriptDescription('htlc_time'); loadExample('and_v(v:pk(Alice),or_d(pk(Bob),and_v(v:hash160(6c60f404f8167a38fc70eaf8aa17ac351023bef8),older(144))))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Time-based HTLC</button>
                        <button onclick="showMiniscriptDescription('htlc_hash'); loadExample('or_d(pk(Alice),and_v(v:hash160(6c60f404f8167a38fc70eaf8aa17ac351023bef8),and_v(v:pk(Bob),older(144))))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Hash-based HTLC</button>
                        <button onclick="showMiniscriptDescription('full_descriptor'); loadExample('pk(MainnetKey)')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Full xpub descriptor</button>
                        <button onclick="showMiniscriptDescription('range_descriptor'); loadExample('pk(RangeKey)')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">Multipath range <1;0>/*</button>
                        <button onclick="showMiniscriptDescription('vault_complex'); loadExample('or_i(or_i(or_i(or_i(and_v(vc:or_i(pk_h(VaultKey1),pk_h(TestnetKey)),after(1753305229)),and_v(or_c(pkh(VaultKey2),v:thresh(2,pkh(VaultKey3),a:pkh(VaultKey4),a:pkh(VaultKey2),a:pkh(TestnetKey),a:pkh(VaultKey1))),after(1753298029))),and_v(or_c(pkh(VaultKey4),v:thresh(2,pkh(VaultKey3),a:pkh(VaultKey4),a:pkh(VaultKey2),a:pkh(TestnetKey))),after(1753290829))),and_v(or_c(pkh(VaultKey3),v:thresh(2,pkh(VaultKey3),a:pkh(VaultKey4),a:pkh(VaultKey2))),after(1753283629))),and_v(v:pk(VaultKey3),pk(VaultKey4)))')" class="secondary-btn" style="font-size: 12px; padding: 6px 12px;">🏦 Complex Vault</button>
                    </div>
                </div>
                
                <div class="miniscript-description-panel" style="flex: 0 0 300px; width: 300px; background: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; display: none; margin-top: 34px; overflow-wrap: break-word; word-wrap: break-word;" id="miniscript-description">
                    <div class="description-content">
                        <h5 style="margin: 0 0 8px 0; color: var(--accent-color); font-size: 14px;">⚙️ Click an example to see description</h5>
                        <p style="margin: 0; color: var(--secondary-text); font-size: 13px; line-height: 1.4;">Click any miniscript example button to learn about its structure and Bitcoin Script patterns.</p>
                    </div>
                </div>
            </div>
            
            <!-- Miniscript Mobile responsive CSS -->
            <style>
                @media (max-width: 768px) {
                    .examples-section:has(.miniscript-description-panel) {
                        flex-direction: column !important;
                        gap: 15px !important;
                    }
                    
                    .miniscript-description-panel {
                        margin-top: 0 !important;
                        flex: none !important;
                        max-width: none !important;
                        width: 100% !important;
                        margin-left: 0 !important;
                        margin-right: 0 !important;
                        box-sizing: border-box !important;
                    }
                    
                    #miniscript-description {
                        width: 100% !important;
                        max-width: 100% !important;
                    }
                }
                
                @media (max-width: 1024px) and (min-width: 769px) {
                    .miniscript-description-panel {
                        flex: 0 0 250px !important;
                        width: 250px !important;
                    }
                }
                
                @media (max-width: 1200px) and (min-width: 1025px) {
                    .miniscript-description-panel {
                        flex: 0 0 280px !important;
                        width: 280px !important;
                    }
                }
            </style>
            
            <div class="context-section" style="margin-top: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-secondary);">Script context:</label>
                <div class="radio-group" style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                        <input type="radio" name="context" value="legacy" style="margin: 0;">
                        <span>Legacy (p2SH)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                        <input type="radio" name="context" value="segwit" checked style="margin: 0;">
                        <span>Segwit v0 (p2WSH)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                        <input type="radio" name="context" value="taproot" style="margin: 0;">
                        <span>Taproot</span>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="button-group">
            <button id="compile-btn" class="primary-btn">🔨 Compile</button>
            <button id="save-btn" class="secondary-btn">💾 Save</button>
            <button id="clear-btn" class="secondary-btn">🗑️ Clear</button>
        </div>
        
        <div id="miniscript-messages" style="margin-bottom: 20px;"></div>
        
        <div class="results-section" id="results" style="margin-bottom: 20px;">
        </div>
        
        <details style="margin-bottom: 20px;">
            <summary style="cursor: pointer; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px;">🔑 Key variables</summary>
            <div style="background: var(--info-bg); padding: 20px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <p style="margin: 0; color: var(--text-muted); flex: 1;">Define key variables to use names like "Alice" and "Bob". Use public keys only!</p>
                    <div style="display: flex; flex-direction: column; gap: 4px; margin-left: 10px; flex-shrink: 0;">
                        <button onclick="compiler.restoreDefaultKeys()" class="secondary-btn" style="padding: 4px 8px; font-size: 12px;">🔄 Restore defaults</button>
                        <button onclick="compiler.clearAllKeys()" class="danger-btn" style="padding: 4px 8px; font-size: 12px;">🗑️ Clear all</button>
                    </div>
                </div>
                
                <div class="add-key-form">
                    <input type="text" id="key-name-input" placeholder="Key name (e.g., Alice)" maxlength="20">
                    <input type="text" id="key-value-input" placeholder="Key value (any format)">
                    <div style="display: flex; gap: 10px;">
                        <button id="add-key-btn" class="primary-btn" style="padding: 8px 12px; font-size: 12px; flex: 1;">➕ Add key</button>
                        <button onclick="generateKey()" class="secondary-btn" style="padding: 8px 12px; font-size: 12px; flex: 1;">🎲 Generate</button>
                    </div>
                </div>
                
                <div class="key-type-panel" style="margin-top: 15px; padding: 15px; background: var(--secondary-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                    <h4 style="margin: 0 0 12px 0; color: var(--text-color); font-size: 14px;">Key type generation:</h4>
                    <div class="radio-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-color); cursor: pointer;">
                            <input type="radio" name="keyType" value="compressed" checked style="margin: 0;">
                            <span>Compressed Public Keys</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-color); cursor: pointer;">
                            <input type="radio" name="keyType" value="xonly" style="margin: 0;">
                            <span>X-only Keys (Taproot)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-color); cursor: pointer;">
                            <input type="radio" name="keyType" value="xpub" style="margin: 0;">
                            <span>Extended Keys (xpub)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-color); cursor: pointer;">
                            <input type="radio" name="keyType" value="tpub" style="margin: 0;">
                            <span>Testnet Keys (tpub)</span>
                        </label>
                    </div>
                </div>
                
                <div id="key-variables-list" style="margin-top: 15px;">
                    <p style="color: var(--text-muted); font-style: italic; font-size: 14px;">No key variables defined.</p>
                </div>
            </div>
        </details>

        <details style="margin-bottom: 20px;">
            <summary style="cursor: pointer; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px;">💾 Saved policies</summary>
            <div style="background: var(--info-bg); padding: 20px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
                <div id="policies-list">
                    <p style="color: var(--text-muted); font-style: italic; font-size: 14px;">No saved policies yet.</p>
                </div>
            </div>
        </details>

        <details style="margin-bottom: 20px;">
            <summary style="cursor: pointer; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px;">📝 Saved miniscript</summary>
            <div style="background: var(--info-bg); padding: 20px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
                <div id="expressions-list">
                    <p style="color: var(--text-muted); font-style: italic; font-size: 14px;">No saved expressions yet.</p>
                </div>
            </div>
        </details>
        
        <details style="margin-bottom: 20px;">
            <summary style="cursor: pointer; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px;">📘 Policy reference</summary>
            <div style="background: var(--info-bg); padding: 20px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
                <h4 style="color: var(--text-secondary);">Basic functions:</h4>
                <ul style="margin: 10px 0; padding-left: 20px; color: var(--text-color); font-size: 13px;">
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">pk(key)</code> - A single public key that must provide a signature</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">older(n)</code> - A relative timelock requiring n blocks/seconds to pass since input creation</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">after(n)</code> - An absolute timelock requiring block height or time n to be reached</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">sha256(h)</code> - A SHA256 hash preimage that must be provided to satisfy the condition</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">hash256(h)</code> - A double-SHA256 hash preimage that must be provided</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">ripemd160(h)</code> - A RIPEMD160 hash preimage that must be provided</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">hash160(h)</code> - A Bitcoin hash160 preimage that must be provided</li>
                </ul>

                <h4 style="color: var(--text-secondary);">Logical operators:</h4>
                <ul style="margin: 10px 0; padding-left: 20px; color: var(--text-color); font-size: 13px;">
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">and(X,Y)</code> - Both conditions X and Y must be satisfied simultaneously</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">or(X,Y)</code> - Either condition X or Y must be satisfied (or both)</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">thresh(k,X,Y,Z,...)</code> - At least k out of the listed conditions must be satisfied</li>
                </ul>


                <p style="margin: 15px 0 10px 0; font-size: 14px; color: var(--text-muted);">
                    <strong>Note:</strong> Policy language provides a high-level, human-readable way to express spending conditions that compile to miniscript. 
                    Keys can be variable names or full hex public keys. Policies are automatically optimized during compilation.
                </p>

                <p style="margin: 10px 0; font-size: 12px; color: var(--text-muted);">
                    <strong>Reference:</strong> <a href="https://bitcoin.sipa.be/miniscript/" target="_blank" style="color: var(--border-focus); text-decoration: none;">https://bitcoin.sipa.be/miniscript/</a>
                </p>
            </div>
        </details>

        <details style="margin-bottom: 20px;">
            <summary style="cursor: pointer; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px;">📚 Miniscript reference</summary>
            <div style="background: var(--info-bg); padding: 20px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
                <h4 style="color: var(--text-secondary);">Basic fragments:</h4>
                <ul style="margin: 10px 0; padding-left: 20px; color: var(--text-color); font-size: 13px;">
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">pk(key)</code> - Requires a signature from the specified public key</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">pk_k(key)</code> - Requires a signature from the specified public key (key directly on stack)</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">pk_h(key)</code> - Requires a signature from a key that hashes to the given value</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">pkh(key)</code> - Requires revealing and signing with a key that hashes to the given hash160</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">older(n)</code> - Requires that the input's relative locktime (nSequence) is at least n blocks/seconds</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">after(n)</code> - Requires that the transaction's locktime (nLockTime) is at least block height/time n</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">sha256(h)</code> - Requires a preimage that produces the given SHA256 hash when hashed</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">hash256(h)</code> - Requires a preimage that produces the given double-SHA256 hash (SHA256 of SHA256)</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">ripemd160(h)</code> - Requires a preimage that produces the given RIPEMD160 hash when hashed</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">hash160(h)</code> - Requires a preimage that produces the given hash160 (RIPEMD160 of SHA256)</li>
                </ul>

                <h4 style="color: var(--text-secondary);">AND combinators:</h4>
                <ul style="margin: 10px 0; padding-left: 20px; color: var(--text-color); font-size: 13px;">
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">and_v(X,Y)</code> - Both X and Y must be satisfied, using VERIFY to check X then evaluating Y</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">and_b(X,Y)</code> - Both X and Y must be satisfied, using BOOLAND to combine their boolean results</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">and_n(X,Y)</code> - Both X and Y must be satisfied, using NOTIF to conditionally execute Y based on X</li>
                </ul>

                <h4 style="color: var(--text-secondary);">OR combinators:</h4>
                <ul style="margin: 10px 0; padding-left: 20px; color: var(--text-color); font-size: 13px;">
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">or_b(X,Y)</code> - Either X or Y must be satisfied, using BOOLOR to combine their boolean results</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">or_c(X,Y)</code> - Either X or Y must be satisfied, using CHECKSIG pattern for efficient evaluation</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">or_d(X,Y)</code> - Either X or Y must be satisfied, using DUP IF to conditionally execute branches</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">or_i(X,Y)</code> - Either X or Y must be satisfied, using IF/ELSE conditional branching</li>
                </ul>

                <h4 style="color: var(--text-secondary);">Mixed combinators:</h4>
                <ul style="margin: 10px 0; padding-left: 20px; color: var(--text-color); font-size: 13px;">
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">andor(X,Y,Z)</code> - Optimized AND-OR: (X AND Y) OR Z pattern using efficient Bitcoin Script</li>
                </ul>

                <h4 style="color: var(--text-secondary);">Threshold:</h4>
                <ul style="margin: 10px 0; padding-left: 20px; color: var(--text-color); font-size: 13px;">
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">thresh(k,X₁,X₂,...,Xₙ)</code> - Requires k out of n sub-expressions to be satisfied</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">multi(k,key₁,key₂,...)</code> - Traditional k-of-n multisig using CHECKMULTISIG (Taproot only)</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">multi_a(k,key₁,key₂,...)</code> - Modern k-of-n multisig using CHECKSIGADD opcodes</li>
                </ul>

                <h4 style="color: var(--text-secondary);">Wrappers:</h4>
                <ul style="margin: 10px 0; padding-left: 20px; color: var(--text-color); font-size: 13px;">
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">a:</code> - Moves the top stack element to/from the altstack for later use</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">s:</code> - Swaps the top two stack elements before evaluation</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">c:</code> - Adds CHECKSIG operation to convert a public key to a signature check</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">t:</code> - Converts any non-zero value to 1 (true), zero values remain 0 (false)</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">d:</code> - Duplicates the top stack element if it's non-zero before conditional execution</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">v:</code> - Adds VERIFY operation to ensure the wrapped expression must evaluate to true</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">j:</code> - Checks if the top element has non-zero size before conditional execution</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">n:</code> - Ensures the top stack element is non-zero (adds 0NOTEQUAL check)</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">l:</code> - Wraps the left branch of a conditional with IF for selective execution</li>
                    <li><code style="background: var(--container-bg); padding: 2px 4px; border-radius: 3px; border: 1px solid var(--border-color);">u:</code> - Wraps the right branch of a conditional with IF for selective execution</li>
                </ul>
                
                <p style="margin: 15px 0 10px 0; font-size: 14px; color: var(--text-muted);">
                    <strong>Note:</strong> Public keys must be 33-byte compressed hex strings (66 characters) for Legacy and Segwit v0, or 32-byte X-only keys (64 characters) for Taproot.
                    The compiler supports Legacy (p2SH), Segwit v0 (p2WSH), and Taproot contexts.
                </p>

                <p style="margin: 10px 0; font-size: 12px; color: var(--text-muted);">
                    <strong>Reference:</strong> <a href="https://bitcoin.sipa.be/miniscript/" target="_blank" style="color: var(--border-focus); text-decoration: none;">https://bitcoin.sipa.be/miniscript/</a>
                </p>
            </div>
        </details>

        <details style="margin-bottom: 20px;">
            <summary style="cursor: pointer; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px;">💡 Tips & Quick Help</summary>
            <div style="background: var(--info-bg); padding: 20px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
                <div style="display: grid; gap: 15px;">
                    <div class="tip-item">
                        <strong style="color: var(--text-color);">🔑 Missing key variables?</strong>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            If compilation of one of the examples fails with "pubkey string should be 66 or 130 digits" (or similar), check if key variables exist by clicking the 🏷️ button to view key content. If no keys are defined, go to "Key variables" section and press "Restore defaults" to restore Alice, Bob, Charlie, etc.
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color);">🧹 Clean up text:</strong>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            The 🧹 button removes extra whitespace and formatting from pasted expressions that prevent them from compiling successfully.
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color);">💾 Save/Load expressions:</strong>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            Save frequently used policies/expressions with the 💾 Save button. Saved items appear in their respective sections for quick reloading.
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color);">🎲 Generate test keys:</strong>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            Use the 🎲 Generate button in Key variables to create random test keys appropriate for your selected script context (xpub, compressed for Legacy/Segwit, X-only for Taproot). 
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color);">🔄 Context auto-detection:</strong>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            Script context automatically switches based on key types: compressed keys (66 chars) → Legacy/Segwit, X-only keys (64 chars) → Taproot.
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color);">📋 Local storage:</strong>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            All data (keys, saved expressions) persists locally in your browser. No server - everything stays private. Use public keys only!
                        </p>
                    </div>
                    <div class="tip-item">
                        <strong style="color: var(--text-color);">🌐 Network detection:</strong>
                        <p style="margin: 4px 0 0 0; color: var(--text-color); font-size: 13px;">
                            Testnet keys (tpub) automatically generate testnet addresses, mainnet keys (xpub) generate mainnet addresses.
                        </p>
                    </div>
                </div>
            </div>
        </details>
        
        </div>
        
        <footer style="text-align: center; margin-top: 40px; padding: 20px; border-top: 1px solid var(--border-color);">
            <p style="color: var(--text-muted); font-size: 14px; margin: 0;">
                <a href="https://github.com/adyshimony/miniscript-compiler" target="_blank" style="color: var(--text-secondary); text-decoration: none;">
                    📁 View source on GitHub
                </a>
            </p>
        </footer>
    </div>
    
    <div id="save-modal" class="modal">
        <div class="modal-content">
            <h3>Save expression</h3>
            <label for="save-name">Expression name:</label>
            <input type="text" id="save-name" placeholder="Enter a name for this expression">
            <div class="button-group" style="margin-top: 20px;">
                <button id="confirm-save" class="primary-btn">Save</button>
                <button id="cancel-save" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <div id="save-policy-modal" class="modal">
        <div class="modal-content">
            <h3>Save policy</h3>
            <label for="save-policy-name">Policy name:</label>
            <input type="text" id="save-policy-name" placeholder="Enter a name for this policy">
            <div class="button-group" style="margin-top: 20px;">
                <button id="confirm-save-policy" class="primary-btn">Save</button>
                <button id="cancel-save-policy" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>
    
    <script type="module" src="script.js"></script>
    <script>
        // Global functions that need to be available immediately
        window.showPolicyDescription = function(exampleId) {
            const panel = document.getElementById('policy-description');
            const contentDiv = panel.querySelector('.description-content');
            
            const descriptions = {
                'single': {
                    title: '📄 Single Key Policy',
                    conditions: '🔓 Alice: Immediate spending (no restrictions)',
                    useCase: 'Personal wallet with single owner. Simple and efficient for individual use.',
                    security: '⚠️ Single point of failure - if Alice loses her key, funds are lost'
                },
                'or': {
                    title: '📄 OR Keys Policy',
                    conditions: '🔓 Alice: Can spend immediately\n🔓 Bob: Can spend immediately',
                    useCase: 'Shared wallet where either party can spend. Useful for joint accounts or backup access.',
                    security: '💡 Either key compromise results in fund loss'
                },
                'and': {
                    title: '📄 AND Keys Policy',
                    conditions: '🔓 Alice + Bob: Both signatures required',
                    useCase: '2-of-2 multisig. Both parties must agree to spend. Common for business partnerships.',
                    security: '💡 More secure but requires cooperation of both parties'
                },
                'threshold': {
                    title: '📄 2-of-3 Threshold Policy',
                    conditions: '🔓 Any 2 of: Alice, Bob, Charlie',
                    useCase: 'Board of directors or family trust. Prevents single point of failure while requiring majority.',
                    security: '💡 Balanced security - survives 1 key loss, prevents 1 key compromise'
                },
                'timelock': {
                    title: '📄 Timelock Policy',
                    conditions: '🔓 Alice: Immediate spending\n⏰ Bob: After 144 blocks (~1 day)',
                    useCase: 'Emergency access with delay. Alice has daily control, Bob can recover after waiting period.',
                    security: '💡 Cooling-off period prevents rushed decisions'
                },
                'xonly': {
                    title: '📄 Taproot X-only Key',
                    conditions: '🔓 David: Immediate spending (Taproot context)',
                    useCase: 'Demonstrates Taproot X-only public keys (64 characters). More efficient and private.',
                    security: '💡 Taproot provides better privacy and efficiency'
                },
                'corporate': {
                    title: '📄 Corporate Wallet Policy',
                    conditions: '🔓 Any 2 of: Alice, Bob, Charlie (board)\n⏰ Eva (CEO): After January 1, 2025',
                    useCase: 'Corporate treasury with board oversight and emergency CEO access after specific date.',
                    security: '💡 Board control with time-delayed executive override'
                },
                'recovery': {
                    title: '📄 Emergency Recovery Policy',
                    conditions: '🔓 Alice: Immediate spending (95% probability weight)\n⏰ Bob + Charlie + Eva: 2-of-3 after 1008 blocks (~1 week)',
                    useCase: 'Personal wallet with family/friends emergency recovery. Alice controls daily, family can recover if needed. The 95@ weight tells miniscript compiler to optimize for Alice\'s path.',
                    security: '💡 Probability weight helps wallets optimize fees and witness sizes for common usage'
                },
                'twofa': {
                    title: '📄 2FA + Backup Policy',
                    conditions: '🔓 Alice + (Bob + secret OR wait 1 year)',
                    useCase: 'Two-factor authentication wallet. Alice + second device, or Alice alone after 1 year backup delay.',
                    security: '💡 Strong 2FA security with long-term recovery option'
                },
                'inheritance': {
                    title: '📄 Taproot Inheritance Policy',
                    conditions: '🔓 David: Immediate spending\n⏰ Helen + Ivan + Julia: 2-of-3 after 26280 blocks (~6 months)',
                    useCase: 'Estate planning. David controls funds, beneficiaries can inherit after extended waiting period.',
                    security: '💡 Long delay ensures David has opportunity to intervene'
                },
                'delayed': {
                    title: '📄 Taproot 2-of-2 OR Delayed',
                    conditions: '🔓 Julia + Karl: Immediate 2-of-2 spending\n⏰ David: After 144 blocks (~1 day)',
                    useCase: 'Joint account with single-party emergency access. Both parties agree, or one party after delay.',
                    security: '💡 Cooperative control with individual fallback'
                }
            };
            
            const desc = descriptions[exampleId];
            if (desc) {
                contentDiv.innerHTML = `
                    <h5 style="margin: 0 0 12px 0; color: var(--accent-color); font-size: 14px;">${desc.title}</h5>
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--text-color); font-size: 12px;">Spending Conditions:</strong>
                        <div style="margin-top: 4px; font-size: 12px; color: var(--secondary-text); white-space: pre-line;">${desc.conditions}</div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--text-color); font-size: 12px;">Use Case:</strong>
                        <div style="margin-top: 4px; font-size: 12px; color: var(--secondary-text); line-height: 1.4;">${desc.useCase}</div>
                    </div>
                    <div>
                        <strong style="color: var(--text-color); font-size: 12px;">Security Notes:</strong>
                        <div style="margin-top: 4px; font-size: 12px; color: var(--secondary-text); line-height: 1.4;">${desc.security}</div>
                    </div>
                `;
                panel.style.display = 'block';
            }
        };

        window.showMiniscriptDescription = function(exampleId) {
            const panel = document.getElementById('miniscript-description');
            const contentDiv = panel.querySelector('.description-content');
            
            const descriptions = {
                'single': {
                    title: '⚙️ Single Key Miniscript',
                    structure: 'pk(Alice) → Direct public key check',
                    bitcoinScript: 'Compiles to: <Alice> CHECKSIG',
                    useCase: 'Simplest miniscript - requires a signature from Alice to spend.',
                    technical: '💡 Most efficient single-key pattern'
                },
                'and': {
                    title: '⚙️ 2-of-2 AND Miniscript',
                    structure: 'and_v(v:pk(Alice),pk(Bob)) → Verify Alice, then check Bob',
                    bitcoinScript: 'Compiles to: <Alice> CHECKSIGVERIFY <Bob> CHECKSIG',
                    useCase: 'Both Alice and Bob must provide signatures. Common for joint accounts or business partnerships.',
                    technical: '💡 Uses VERIFY wrapper for efficient sequential checking'
                },
                'or': {
                    title: '⚙️ OR Keys Miniscript',
                    structure: 'or_b(pk(Alice),s:pk(Bob)) → Boolean OR with stack swap',
                    bitcoinScript: 'Compiles to: <Alice> CHECKSIG SWAP <Bob> CHECKSIG BOOLOR',
                    useCase: 'Either Alice or Bob can spend. Useful for backup access or shared control.',
                    technical: '💡 s: wrapper swaps stack elements for proper evaluation'
                },
                'complex': {
                    title: '⚙️ Complex AND/OR Miniscript',
                    structure: 'and_v(v:pk(Alice),or_b(pk(Bob),s:pk(Charlie))) → Alice AND (Bob OR Charlie)',
                    bitcoinScript: 'Alice verified first, then Bob OR Charlie evaluated',
                    useCase: 'Alice must always sign, plus either Bob or Charlie. Useful for primary + backup authorization.',
                    technical: '💡 Nested structure demonstrates miniscript composition'
                },
                'timelock': {
                    title: '⚙️ Timelock Miniscript',
                    structure: 'and_v(v:pk(Alice),and_v(v:older(144),pk(Bob))) → Alice AND (144 blocks + Bob)',
                    bitcoinScript: 'Verifies Alice, then checks timelock and Bob signature',
                    useCase: 'Alice must sign, plus Bob can only sign after 144 blocks (~1 day). Prevents rushed decisions.',
                    technical: '💡 Relative timelock using CSV (CHECKSEQUENCEVERIFY)'
                },
                'xonly': {
                    title: '⚙️ Taproot X-only Key',
                    structure: 'pk(David) → X-only public key (64 chars)',
                    bitcoinScript: 'Compiles to Taproot-compatible script using 32-byte keys',
                    useCase: 'Demonstrates Taproot X-only public keys for improved efficiency and privacy.',
                    technical: '💡 Taproot uses Schnorr signatures with X-only keys'
                },
                'multisig': {
                    title: '⚙️ 1-of-3 Multisig Miniscript',
                    structure: 'or_d(pk(Alice),or_d(pk(Bob),pk(Charlie))) → Nested OR with DUP',
                    bitcoinScript: 'Conditional execution using DUP IF pattern for each branch',
                    useCase: 'Any of three parties can spend. More flexible than traditional CHECKMULTISIG.',
                    technical: '💡 or_d uses DUP IF for efficient conditional branching'
                },
                'recovery': {
                    title: '⚙️ Recovery Wallet Miniscript',
                    structure: 'or_d(pk(Alice),and_v(v:pk(Bob),older(1008))) → Alice OR (Bob + delay)',
                    bitcoinScript: 'Alice immediate, or Bob after 1008 blocks verification',
                    useCase: 'Alice has daily control, Bob can recover funds after ~1 week waiting period.',
                    technical: '💡 Combines immediate access with time-delayed recovery'
                },
                'hash': {
                    title: '⚙️ Hash + Timelock Miniscript',
                    structure: 'and_v(v:pk(Alice),or_d(pk(Bob),and_v(v:hash160(...),older(144))))',
                    bitcoinScript: 'Alice AND (Bob OR (secret + timelock))',
                    useCase: 'Alice + Bob normally, or Alice + secret after delay. Two-factor authentication pattern.',
                    technical: '💡 hash160 requires RIPEMD160(SHA256(preimage))'
                },
                'inheritance': {
                    title: '⚙️ Taproot Inheritance Miniscript',
                    structure: 'and_v(v:pk(David),or_d(pk(Helen),and_v(v:pk(Ivan),older(52560))))',
                    bitcoinScript: 'David AND (Helen OR (Ivan + 1 year))',
                    useCase: 'David controls funds, Helen can inherit immediately, or Ivan after extended delay.',
                    technical: '💡 Long timelock (52560 blocks ≈ 1 year) for inheritance planning'
                },
                'delayed': {
                    title: '⚙️ Taproot Immediate OR Delayed',
                    structure: 'or_d(pk(Julia),and_v(v:pk(Karl),older(144))) → Julia OR (Karl + delay)',
                    bitcoinScript: 'Julia immediate OR Karl after 144 blocks',
                    useCase: 'Julia can spend immediately, Karl can spend after 1-day cooling period.',
                    technical: '💡 Demonstrates Taproot miniscript with short timelock'
                }
            };
            
            const desc = descriptions[exampleId];
            if (desc) {
                contentDiv.innerHTML = `
                    <h5 style="margin: 0 0 12px 0; color: var(--accent-color); font-size: 14px;">${desc.title}</h5>
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--text-color); font-size: 12px;">Structure:</strong>
                        <div style="margin-top: 4px; font-size: 12px; color: var(--secondary-text); line-height: 1.4; font-family: monospace; background: var(--hover-bg); padding: 6px; border-radius: 4px;">${desc.structure}</div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--text-color); font-size: 12px;">Bitcoin Script:</strong>
                        <div style="margin-top: 4px; font-size: 12px; color: var(--secondary-text); line-height: 1.4;">${desc.bitcoinScript}</div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--text-color); font-size: 12px;">Use Case:</strong>
                        <div style="margin-top: 4px; font-size: 12px; color: var(--secondary-text); line-height: 1.4;">${desc.useCase}</div>
                    </div>
                    <div>
                        <strong style="color: var(--text-color); font-size: 12px;">Technical Notes:</strong>
                        <div style="margin-top: 4px; font-size: 12px; color: var(--secondary-text); line-height: 1.4;">${desc.technical}</div>
                    </div>
                `;
                panel.style.display = 'block';
            }
        };

        window.loadExample = function(example) {
            document.getElementById('expression-input').value = example;
            document.getElementById('results').innerHTML = '';
            if (window.compiler && window.compiler.clearMiniscriptMessages) {
                window.compiler.clearMiniscriptMessages();
            }
            
            // Auto-detect context based on key formats in the example (only if compiler is ready)
            if (window.compiler && window.compiler.detectContextFromExpression) {
                const detectedContext = window.compiler.detectContextFromExpression(example);
                const context = detectedContext || 'segwit';
                document.querySelector(`input[name="context"][value="${context}"]`).checked = true;
            }
            
            // Reset the "Show key names" checkbox
            const checkbox = document.getElementById('replace-keys-checkbox');
            if (checkbox) {
                checkbox.checked = false;
            }
        };

        window.loadPolicyExample = function(example) {
            document.getElementById('policy-input').value = example;
            document.getElementById('expression-input').value = '';
            document.getElementById('results').innerHTML = '';
            document.getElementById('policy-errors').innerHTML = '';
            
            // Auto-detect context based on key formats in the example (only if compiler is ready)
            if (window.compiler && window.compiler.detectContextFromExpression) {
                const detectedContext = window.compiler.detectContextFromExpression(example);
                const context = detectedContext || 'segwit';
                document.querySelector(`input[name="context"][value="${context}"]`).checked = true;
            }
            
            // Reset the "Show key names" checkbox since we cleared the miniscript
            const checkbox = document.getElementById('replace-keys-checkbox');
            if (checkbox) {
                checkbox.checked = false;
            }
        };

    </script>
</body>
</html>